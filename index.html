<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UniChat ‚Äî with advanced friend requests</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html,body{height:100%}
  body{transition:background .3s,color .3s}
  .dark body{background:#0f172a;color:#f1f5f9}
  .dark .bg-white{background:#1e293b !important;color:#f8fafc}
  .dark input,.dark textarea{background:#334155 !important;color:#f8fafc}
  .post-img{max-width:100%;border-radius:0.5rem}
  .video-preview{max-width:200px;max-height:200px;border-radius:.5rem}
  .btn-disabled{opacity:0.6;pointer-events:none;}
</style>
</head>
<body class="bg-sky-50 text-slate-900 min-h-full">

<div class="max-w-6xl mx-auto p-4">

  <!-- HEADER -->
  <header class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold">UniChat <span class="text-sky-600">demo</span></h1>
    <nav class="flex items-center gap-3">
      <button class="menu-btn px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" data-tab="friendsTab">–î—Ä—É–∑—å—è</button>
      <button class="menu-btn px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" data-tab="feedTab">–õ–µ–Ω—Ç–∞</button>
      <button class="menu-btn px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" data-tab="settingsTab">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </nav>
    <div class="flex items-center gap-3">
      <span id="headerEmail" class="text-sm text-slate-600 cursor-pointer"></span>
      <img id="headerAvatar" src="" alt="avatar" class="w-10 h-10 rounded-full border object-cover cursor-pointer"/>
      <button id="btnSignOut" class="hidden px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <!-- AUTH -->
  <section id="auth" class="grid gap-3 bg-white rounded-2xl p-4 shadow">
    <h2 class="font-semibold">–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <div class="grid md:grid-cols-2 gap-3">
      <input id="email" type="email" placeholder="email" class="px-3 py-2 rounded-xl bg-slate-100"/>
      <input id="password" type="password" placeholder="–ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6)" class="px-3 py-2 rounded-xl bg-slate-100"/>
    </div>
    <div class="flex gap-2">
      <button id="btnRegister" class="px-4 py-2 rounded-xl bg-sky-600 text-white">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <button id="btnLogin" class="px-4 py-2 rounded-xl bg-sky-600/70 text-white">–í–æ–π—Ç–∏</button>
      <label class="flex items-center gap-2 text-sm ml-2"><input id="remember" type="checkbox" checked/> –∑–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">

    <main class="grid md:grid-cols-[260px_1fr] gap-4">

      <!-- LEFT: friends/search/requests/settings -->
      <aside class="bg-white rounded-2xl p-4 shadow">
        <div id="friendsTab" class="tab-content">
          <h3 class="font-semibold mb-2">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
          <input id="friendSearch" placeholder="–ü–æ –Ω–∏–∫—É" class="w-full px-3 py-2 rounded-xl bg-slate-100 mb-2"/>
          <div id="friendResults" class="max-h-40 overflow-y-auto grid gap-1 mb-4"></div>

          <h3 class="font-semibold mb-2">–ú–æ–∏ –¥—Ä—É–∑—å—è</h3>
          <div id="friendList" class="max-h-48 overflow-y-auto grid gap-1 mb-4"></div>

          <h3 class="font-semibold mb-2">–ó–∞—è–≤–∫–∏ (–≤—Ö–æ–¥—è—â–∏–µ)</h3>
          <div id="friendRequests" class="max-h-40 overflow-y-auto grid gap-1 mb-4"></div>

          <h3 class="font-semibold mb-2">–ò—Å—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏</h3>
          <div id="sentRequestsList" class="max-h-40 overflow-y-auto grid gap-1"></div>
        </div>

        <div id="settingsTab" class="tab-content hidden mt-4">
          <h3 class="font-semibold mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <button class="theme-toggle px-3 py-2 rounded-xl bg-slate-200">üåô –¢–µ–º–∞</button>
        </div>
      </aside>

      <!-- MAIN -->
      <section class="grid gap-4">

        <!-- FEED -->
        <div id="feedTab" class="tab-content hidden bg-white rounded-2xl p-4 shadow">
          <div class="mb-4">
            <textarea id="postInput" placeholder="–í–∞—à –ø–æ—Å—Ç..." class="w-full px-3 py-2 rounded-xl bg-slate-100"></textarea>
            <input id="postFile" type="file" accept="image/*" class="hidden"/>
            <div class="flex gap-2 mt-2">
              <button id="btnPostFile" class="px-3 py-2 rounded-xl bg-slate-200">üìé</button>
              <button id="btnPost" class="px-4 py-2 rounded-xl bg-sky-600 text-white">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>
          </div>
          <div id="postList" class="grid gap-2"></div>
        </div>

        <!-- CHAT AREA -->
        <div id="chatArea" class="bg-white rounded-2xl p-4 shadow hidden">
          <h3 id="chatTitle" class="font-semibold mb-2">–ß–∞—Ç</h3>
          <div id="messages" class="flex-1 overflow-y-auto grid gap-2 max-h-[360px] pr-2"></div>
          <div class="mt-3 flex gap-2">
            <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" class="px-3 py-2 rounded-xl bg-slate-100 flex-1"/>
            <input id="fileInput" type="file" accept="image/*,audio/*" class="hidden"/>
            <button id="btnFile" class="px-3 py-2 rounded-xl bg-slate-200">üìé</button>
            <button id="btnSend" class="px-4 py-2 rounded-xl bg-sky-600 text-white">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>

        <!-- FRIEND PROFILE -->
        <div id="friendProfile" class="hidden bg-white rounded-2xl p-4 shadow">
          <img id="friendAvatar" src="" class="w-24 h-24 rounded-full mx-auto mb-2"/>
          <h3 id="friendNick" class="text-center font-semibold mb-1"></h3>
          <p id="friendDesc" class="text-center text-sm text-slate-600 mb-3"></p>
          <div class="flex justify-center gap-2">
            <button id="btnAddFriend" class="px-3 py-2 rounded-xl bg-sky-600 text-white">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button id="btnChatFriend" class="px-3 py-2 rounded-xl bg-green-600 text-white">–ß–∞—Ç</button>
          </div>
        </div>

        <!-- MY PROFILE -->
        <div id="myProfile" class="hidden bg-white rounded-2xl p-4 shadow">
          <label class="cursor-pointer mx-auto block w-fit">
            <input id="myAvatarUpload" type="file" accept="image/*" class="hidden"/>
            <img id="myAvatar" src="" class="w-24 h-24 rounded-full mx-auto mb-2 object-cover"/>
            <div class="text-center text-sm text-slate-500">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</div>
          </label>
          <input id="myNick" placeholder="–ù–∏–∫" class="w-full px-3 py-2 rounded-xl bg-slate-100"/>
          <textarea id="myDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="w-full px-3 py-2 rounded-xl bg-slate-100 mt-2"></textarea>
          <div class="flex justify-end mt-2">
            <button id="btnSaveProfile" class="px-3 py-2 rounded-xl bg-sky-600 text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>

      </section>
    </main>
  </section>
</div>

<!-- FIREBASE + LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, inMemoryPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDoc, updateDoc, query, orderBy, onSnapshot, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCJeZ2RyApZueVvqYzdctLRTuo9kIfySzE",
  authDomain: "umi-chat-500c6.firebaseapp.com",
  projectId: "umi-chat-500c6",
  storageBucket: "umi-chat-500c6.appspot.com",
  messagingSenderId: "340727638941",
  appId: "1:340727638941:web:581218a8ff4fa098a85d74"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------- ELEMENTS ---------- */
const authBox = document.getElementById("auth");
const appBox = document.getElementById("app");
const headerEmail = document.getElementById("headerEmail");
const headerAvatar = document.getElementById("headerAvatar");
const btnSignOut = document.getElementById("btnSignOut");

const menuBtns = document.querySelectorAll(".menu-btn");
const tabs = document.querySelectorAll(".tab-content");
const themeToggles = document.querySelectorAll(".theme-toggle");

const friendSearch = document.getElementById("friendSearch");
const friendResults = document.getElementById("friendResults");
const friendList = document.getElementById("friendList");
const friendRequests = document.getElementById("friendRequests");
const sentRequestsList = document.getElementById("sentRequestsList");

const friendProfile = document.getElementById("friendProfile");
const friendAvatar = document.getElementById("friendAvatar");
const friendNick = document.getElementById("friendNick");
const friendDesc = document.getElementById("friendDesc");
const btnAddFriend = document.getElementById("btnAddFriend");
const btnChatFriend = document.getElementById("btnChatFriend");

const myProfile = document.getElementById("myProfile");
const myAvatarUpload = document.getElementById("myAvatarUpload");
const myAvatar = document.getElementById("myAvatar");
const myNick = document.getElementById("myNick");
const myDesc = document.getElementById("myDesc");
const btnSaveProfile = document.getElementById("btnSaveProfile");

const feedTab = document.getElementById("feedTab");
const postInput = document.getElementById("postInput");
const postFile = document.getElementById("postFile");
const btnPostFile = document.getElementById("btnPostFile");
const btnPost = document.getElementById("btnPost");
const postList = document.getElementById("postList");

const chatArea = document.getElementById("chatArea");
const chatTitle = document.getElementById("chatTitle");
const messages = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const fileInput = document.getElementById("fileInput");
const btnFile = document.getElementById("btnFile");
const btnSend = document.getElementById("btnSend");

/* ---------- STATE ---------- */
let currentUser = null;
let currentUserDoc = null;
let selectedFriendUid = null;
let currentChatId = null;
let postsUnsub = null;
let chatUnsub = null;

/* ---------- HELPERS ---------- */
function showTab(name){
  tabs.forEach(t=>t.classList.add("hidden"));
  const el = document.getElementById(name);
  if(el) el.classList.remove("hidden");
  friendProfile.classList.add("hidden");
  myProfile.classList.add("hidden");
  chatArea.classList.add("hidden");
}
menuBtns.forEach(b=>b.addEventListener("click", ()=> showTab(b.dataset.tab)));
themeToggles.forEach(t=>t.addEventListener("click", ()=> document.documentElement.classList.toggle("dark")));

function safeText(s){ return s? String(s): ""; }

/* ---------- AUTH ---------- */
document.getElementById("btnRegister").onclick = () => {
  const emailVal = document.getElementById("email").value;
  const passwordVal = document.getElementById("password").value;
  createUserWithEmailAndPassword(auth, emailVal, passwordVal)
    .then(async cred => {
      await setDoc(doc(db,"users",cred.user.uid), {
        displayName: cred.user.email.split("@")[0],
        email: cred.user.email,
        photoURL: "",
        description: "",
        friends: [],
        friendRequests: [],
        sentRequests: []
      }, { merge:true });
    })
    .catch(e=>alert(e.message));
};

document.getElementById("btnLogin").onclick = () => {
  const emailVal = document.getElementById("email").value;
  const passwordVal = document.getElementById("password").value;
  const persistence = document.getElementById("remember").checked ? browserLocalPersistence : inMemoryPersistence;
  setPersistence(auth,persistence).then(() => 
    signInWithEmailAndPassword(auth, emailVal, passwordVal)
  ).catch(e => alert(e.message));
};


btnSignOut.onclick = ()=> signOut(auth);

onAuthStateChanged(auth, async user => {
  currentUser = user;
  if(user){
    authBox.classList.add("hidden");
    appBox.classList.remove("hidden");
    headerEmail.textContent = user.email;
    btnSignOut.classList.remove("hidden");

    // load user document or create default
    const udocRef = doc(db,"users",user.uid);
    const udocSnap = await getDoc(udocRef);
    if(!udocSnap.exists()){
      await setDoc(udocRef, {
        displayName: user.displayName || user.email.split("@")[0],
        email: user.email,
        photoURL: user.photoURL || "",
        description: "",
        friends: [],
        friendRequests: [],
        sentRequests: []
      }, { merge:true });
    }
    currentUserDoc = (await getDoc(udocRef)).data();

    headerAvatar.src = currentUserDoc.photoURL || "";
    showTab("feedTab");
    subscribePosts();
    renderFriendsList();
    renderRequests();
    renderSentRequests();
  } else {
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
    headerEmail.textContent = "";
    headerAvatar.src = "";
    btnSignOut.classList.add("hidden");
    if(postsUnsub){ postsUnsub(); postsUnsub = null; }
    if(chatUnsub){ chatUnsub(); chatUnsub = null; }
  }
});

/* ---------- PROFILE (MY) ---------- */
headerEmail.addEventListener("click", ()=> openMyProfile());
headerAvatar.addEventListener("click", ()=> openMyProfile());

function openMyProfile(){
  myProfile.classList.remove("hidden");
  friendProfile.classList.add("hidden");
  chatArea.classList.add("hidden");
  tabs.forEach(t=>t.classList.add("hidden"));
  myAvatar.src = (currentUserDoc && currentUserDoc.photoURL) || (currentUser && currentUser.photoURL) || "";
  myNick.value = (currentUserDoc && currentUserDoc.displayName) || (currentUser && currentUser.displayName) || "";
  myDesc.value = (currentUserDoc && currentUserDoc.description) || "";
}

/* upload avatar (base64) and persist in auth profile + users/{uid} doc */
myAvatarUpload.addEventListener("change", async e=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async ()=> {
    const base64 = reader.result;
    try { await updateProfile(auth.currentUser, { photoURL: base64 }); } catch(e){ console.warn(e); }
    await setDoc(doc(db,"users",currentUser.uid), { photoURL: base64 }, { merge:true });
    currentUserDoc = { ...(currentUserDoc||{}), photoURL: base64 };
    myAvatar.src = base64;
    headerAvatar.src = base64;
    renderFriendsList();
  };
  reader.readAsDataURL(file);
});

btnSaveProfile.addEventListener("click", async ()=>{
  const nick = myNick.value.trim();
  const desc = myDesc.value.trim();
  if(!nick) return alert("–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
  try{ await updateProfile(auth.currentUser, { displayName: nick }); } catch(e){ console.warn(e); }
  await setDoc(doc(db,"users",currentUser.uid), {
    displayName: nick,
    description: desc,
    email: currentUser.email,
    photoURL: currentUserDoc?.photoURL || currentUser.photoURL || ""
  }, { merge:true });
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
  headerAvatar.src = currentUserDoc.photoURL || "";
  headerEmail.textContent = currentUser.email;
  renderFriendsList();
});

/* ---------- FRIENDS: search/profile/requests/list (advanced) ---------- */
friendSearch.addEventListener("input", async ()=>{
  friendResults.innerHTML = "";
  const q = friendSearch.value.trim().toLowerCase();
  if(!q) return;
  const usersSnap = await getDocs(collection(db,"users"));
  usersSnap.forEach(u=>{
    const d = u.data();
    if(!d || !d.displayName) return;
    if(u.id === currentUser.uid) return;
    if(d.displayName.toLowerCase().includes(q)){
      const div = document.createElement("div");
      div.className = "flex items-center gap-2 p-1 cursor-pointer hover:bg-slate-50 rounded";
      div.innerHTML = `<img src="${d.photoURL||''}" class="w-8 h-8 rounded-full object-cover"/><div>${d.displayName}</div>`;
      div.onclick = ()=> openUserProfile(u.id, d);
      friendResults.appendChild(div);
    }
  });
});

async function openUserProfile(uid, data){
  selectedFriendUid = uid;
  friendAvatar.src = data.photoURL || "";
  friendNick.textContent = data.displayName || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
  const snap = await getDoc(doc(db,"users",uid));
  const docdata = snap.exists() ? snap.data() : {};
  friendDesc.textContent = docdata.description || "";

  // determine relationship state
  const amFriend = Array.isArray(currentUserDoc?.friends) && currentUserDoc.friends.includes(uid);
  const iSent = Array.isArray(currentUserDoc?.sentRequests) && currentUserDoc.sentRequests.includes(uid);
  const theySent = Array.isArray(currentUserDoc?.friendRequests) && currentUserDoc.friendRequests.includes(uid); // note: this checks incoming to current user
  // But to check if THEY sent a request to YOU, better inspect docdata.friendRequests
  const theySentToMe = Array.isArray(docdata.friendRequests) && docdata.friendRequests.includes(currentUser.uid);

  // Set button states
  btnChatFriend.disabled = !amFriend;

  if(amFriend){
    btnAddFriend.textContent = "–í—ã –¥—Ä—É–∑—å—è";
    btnAddFriend.classList.add("btn-disabled");
  } else if(iSent){
    btnAddFriend.textContent = "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞";
    btnAddFriend.classList.add("btn-disabled");
  } else if(theySentToMe){
    // The other user already sent you a request -> show "–ü—Ä–∏–Ω—è—Ç—å" in requests area; but in profile we can show "–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∑–∞—è–≤–∫–∞"
    btnAddFriend.textContent = "–ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É";
    btnAddFriend.classList.remove("btn-disabled");
    // repurpose the click to accept
    btnAddFriend.onclick = async ()=> {
      await acceptRequestFrom(uid);
      // refresh profile and lists
      currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
      openUserProfile(uid, docdata);
      renderFriendsList();
      renderRequests();
      renderSentRequests();
    };
    friendProfile.classList.remove("hidden");
    myProfile.classList.add("hidden");
    chatArea.classList.add("hidden");
    return;
  } else {
    btnAddFriend.textContent = "–î–æ–±–∞–≤–∏—Ç—å";
    btnAddFriend.classList.remove("btn-disabled");
  }

  // default handler for adding (send request)
  btnAddFriend.onclick = ()=> sendFriendRequest(uid);
  friendProfile.classList.remove("hidden");
  myProfile.classList.add("hidden");
  chatArea.classList.add("hidden");
}

/* send friend request (adds to recipient.friendRequests and sender.sentRequests) */
async function sendFriendRequest(uid){
  if(!uid) return;
  // check local state to avoid duplicates
  if(Array.isArray(currentUserDoc?.sentRequests) && currentUserDoc.sentRequests.includes(uid)) {
    alert("–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
    return;
  }
  // update both documents atomically in two ops (Firestore doesn't have cross-doc transactions in rules here; client-side two updates)
  await updateDoc(doc(db,"users",uid), { friendRequests: arrayUnion(currentUser.uid) });
  await updateDoc(doc(db,"users",currentUser.uid), { sentRequests: arrayUnion(uid) });

  // optimistic UI: update local copy and render
  currentUserDoc.sentRequests = Array.isArray(currentUserDoc.sentRequests) ? currentUserDoc.sentRequests.concat(uid) : [uid];
  alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
  renderSentRequests();
  // Update profile button state
  btnAddFriend.textContent = "–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞";
  btnAddFriend.classList.add("btn-disabled");
}

/* render incoming requests (friendRequests) */
async function renderRequests(){
  friendRequests.innerHTML = "";
  const snap = await getDoc(doc(db,"users",currentUser.uid));
  const data = snap.exists() ? snap.data() : {};
  currentUserDoc = data;
  const reqs = Array.isArray(data.friendRequests) ? data.friendRequests : [];
  for(const uid of reqs){
    try{
      const userSnap = await getDoc(doc(db,"users",uid));
      const ud = userSnap.exists() ? userSnap.data() : { displayName: uid };
      const div = document.createElement("div");
      div.className = "flex justify-between items-center p-1";
      div.innerHTML = `<div class="flex items-center gap-2"><img src="${ud.photoURL||''}" class="w-8 h-8 rounded-full object-cover"/><div>${ud.displayName||uid}</div></div>
        <div class="flex gap-1">
          <button class="px-2 py-1 bg-green-600 text-white rounded" onclick="acceptRequestFrom('${uid}')">–ü—Ä–∏–Ω—è—Ç—å</button>
          <button class="px-2 py-1 bg-red-600 text-white rounded" onclick="declineRequestFrom('${uid}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>`;
      friendRequests.appendChild(div);
    }catch(e){ console.warn(e); }
  }
}

/* accept request: uid (who sent YOU the request) */
window.acceptRequestFrom = async (uid) => {
  // add each other as friends, remove from friendRequests and sentRequests
  await updateDoc(doc(db,"users",currentUser.uid), {
    friends: arrayUnion(uid),
    friendRequests: arrayRemove(uid)
  });
  await updateDoc(doc(db,"users",uid), {
    friends: arrayUnion(currentUser.uid),
    sentRequests: arrayRemove(currentUser.uid)
  });
  // refresh local doc and UI
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  renderFriendsList();
  renderRequests();
  renderSentRequests();
};

/* decline incoming request */
window.declineRequestFrom = async (uid) => {
  await updateDoc(doc(db,"users",currentUser.uid), { friendRequests: arrayRemove(uid) });
  await updateDoc(doc(db,"users",uid), { sentRequests: arrayRemove(currentUser.uid) });
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  renderRequests();
  renderSentRequests();
};

/* render outgoing/sent requests */
async function renderSentRequests(){
  sentRequestsList.innerHTML = "";
  const snap = await getDoc(doc(db,"users",currentUser.uid));
  const data = snap.exists() ? snap.data() : {};
  currentUserDoc = data;
  const sent = Array.isArray(data.sentRequests) ? data.sentRequests : [];
  for(const uid of sent){
    try{
      const userSnap = await getDoc(doc(db,"users",uid));
      const ud = userSnap.exists() ? userSnap.data() : { displayName: uid };
      const div = document.createElement("div");
      div.className = "flex justify-between items-center p-1";
      div.innerHTML = `<div class="flex items-center gap-2"><img src="${ud.photoURL||''}" class="w-8 h-8 rounded-full object-cover"/><div>${ud.displayName||uid}</div></div>
        <div class="flex gap-1">
          <button class="px-2 py-1 bg-red-600 text-white rounded" onclick="cancelSentRequest('${uid}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>`;
      sentRequestsList.appendChild(div);
    }catch(e){ console.warn(e); }
  }
}

/* cancel outgoing request */
window.cancelSentRequest = async (uid) => {
  await updateDoc(doc(db,"users",currentUser.uid), { sentRequests: arrayRemove(uid) });
  await updateDoc(doc(db,"users",uid), { friendRequests: arrayRemove(currentUser.uid) });
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  renderSentRequests();
  renderRequests();
};

/* render friend list */
async function renderFriendsList(){
  friendList.innerHTML = "";
  const snap = await getDoc(doc(db,"users",currentUser.uid));
  const data = snap.exists() ? snap.data() : {};
  currentUserDoc = data;
  const friends = Array.isArray(data.friends) ? data.friends : [];
  for(const uid of friends){
    try{
      const uSnap = await getDoc(doc(db,"users",uid));
      const ud = uSnap.exists() ? uSnap.data() : { displayName: uid };
      const item = document.createElement("div");
      item.className = "flex items-center justify-between gap-2 p-1 hover:bg-slate-50 rounded cursor-pointer";
      item.innerHTML = `<div class="flex items-center gap-2"><img src="${ud.photoURL||''}" class="w-8 h-8 rounded-full object-cover"/><div>${ud.displayName||uid}</div></div>
        <div class="flex gap-1"><button class="text-sm px-2 py-1 rounded bg-red-600 text-white" onclick="removeFriend('${uid}'); event.stopPropagation();">–£–¥–∞–ª–∏—Ç—å</button></div>`;
      item.onclick = ()=> openChat(uid, ud.displayName||uid);
      friendList.appendChild(item);
    }catch(e){ console.warn(e); }
  }
}
window.removeFriend = async (uid)=>{
  await updateDoc(doc(db,"users",currentUser.uid), { friends: arrayRemove(uid) });
  await updateDoc(doc(db,"users",uid), { friends: arrayRemove(currentUser.uid) });
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  renderFriendsList();
};

/* ---------- POSTS (feed) ---------- */
function subscribePosts(){
  if(postsUnsub) postsUnsub();
  const q = query(collection(db,"posts"), orderBy("time","desc"));
  postsUnsub = onSnapshot(q, snap => postListRender(snap.docs.map(d=>({ id:d.id, ...d.data() }))), err => console.warn(err));
}
function postListRender(items){
  postList.innerHTML = "";
  items.forEach(p=>{
    const el = document.createElement("div");
    el.className = "border p-2 rounded-xl";
    const header = document.createElement("div");
    header.className = "flex items-center gap-2 mb-2";
    header.innerHTML = `<img src="${p.avatar||''}" class="w-8 h-8 rounded-full object-cover"/><div class="font-semibold">${safeText(p.displayName||p.uid)}</div>`;
    el.appendChild(header);
    const content = document.createElement("div");
    content.innerHTML = `<div>${safeText(p.content)}</div>`;
    el.appendChild(content);
    if(p.file){
      const img = document.createElement("img");
      img.src = p.file;
      img.className = "post-img mt-2";
      el.appendChild(img);
    }
    postList.appendChild(el);
  });
}

btnPostFile.addEventListener("click", ()=> postFile.click());
btnPost.addEventListener("click", async ()=>{
  const text = postInput.value.trim();
  if(!text && !postFile.files[0]) return alert("–ü—É—Å—Ç–æ–π –ø–æ—Å—Ç");
  if(postFile.files[0]){
    const f = postFile.files[0];
    const reader = new FileReader();
    reader.onload = async () => {
      const fileData = reader.result;
      await addPostToDb(text, fileData);
      postInput.value = ""; postFile.value = "";
    };
    reader.readAsDataURL(f);
  } else {
    await addPostToDb(text, "");
    postInput.value = "";
  }
});
async function addPostToDb(content, file){
  await addDoc(collection(db,"posts"), {
    uid: currentUser.uid,
    displayName: currentUserDoc?.displayName || currentUser.displayName || "",
    avatar: currentUserDoc?.photoURL || currentUser.photoURL || "",
    content,
    file,
    time: Date.now()
  });
}

/* ---------- CHAT ---------- */
async function openChat(friendUid, friendName){
  if(chatUnsub){ chatUnsub(); chatUnsub = null; }
  selectedFriendUid = friendUid;
  currentChatId = [currentUser.uid, friendUid].sort().join("_");
  chatTitle.textContent = "–ß–∞—Ç —Å " + (friendName || friendUid);
  messages.innerHTML = "";
  chatArea.classList.remove("hidden");
  friendProfile.classList.add("hidden");
  myProfile.classList.add("hidden");
  const q = query(collection(db,"chats",currentChatId,"messages"), orderBy("time"));
  chatUnsub = onSnapshot(q, snap=>{
    messages.innerHTML = "";
    snap.forEach(d=> renderMessage(d.id, d.data()));
    messages.scrollTop = messages.scrollHeight;
  }, err => console.warn("chat onSnapshot", err));
}

btnSend.addEventListener("click", async ()=>{
  if(!currentChatId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞");
  const text = msgInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"chats",currentChatId,"messages"), {
    uid: currentUser.uid,
    avatar: currentUserDoc?.photoURL || currentUser.photoURL || "",
    type: "text",
    content: text,
    time: Date.now()
  });
  msgInput.value = "";
});

btnFile.addEventListener("click", ()=> fileInput.click());
fileInput.addEventListener("change", async e=>{
  if(!currentChatId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞");
  const f = e.target.files?.[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = async () => {
    const result = reader.result;
    const type = f.type.startsWith("image") ? "image" : "voice";
    await addDoc(collection(db,"chats",currentChatId,"messages"), {
      uid: currentUser.uid,
      avatar: currentUserDoc?.photoURL || currentUser.photoURL || "",
      type,
      content: result,
      time: Date.now()
    });
  };
  reader.readAsDataURL(f);
});

function renderMessage(id, m){
  const w = document.createElement("div");
  w.className = "flex gap-2 items-start msg p-2 rounded-xl bg-slate-50";
  const who = document.createElement("img");
  who.src = m.avatar || "";
  who.className = "w-8 h-8 rounded-full object-cover";
  const body = document.createElement("div");
  body.className = "flex flex-col";
  const whoLine = document.createElement("div");
  whoLine.className = "text-xs text-slate-500";
  whoLine.textContent = (m.uid === currentUser.uid) ? "–í—ã" : "";
  let inner;
  if(m.type === "text") inner = `<div>${m.content}</div>`;
  else if(m.type === "image") inner = `<img class="video-preview" src="${m.content}"/>`;
  else inner = `<audio controls src="${m.content}"></audio>`;
  body.innerHTML = whoLine.outerHTML + inner;
  w.appendChild(who);
  w.appendChild(body);
  messages.appendChild(w);
}

/* expose for inline onclicks if needed */
window.acceptRequestFrom = async (uid) => {
  await updateDoc(doc(db,"users",currentUser.uid), {
    friends: arrayUnion(uid),
    friendRequests: arrayRemove(uid)
  });
  await updateDoc(doc(db,"users",uid), {
    friends: arrayUnion(currentUser.uid),
    sentRequests: arrayRemove(currentUser.uid)
  });
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  renderFriendsList(); renderRequests(); renderSentRequests();
};
window.declineRequestFrom = async (uid) => {
  await updateDoc(doc(db,"users",currentUser.uid), { friendRequests: arrayRemove(uid) });
  await updateDoc(doc(db,"users",uid), { sentRequests: arrayRemove(currentUser.uid) });
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  renderRequests(); renderSentRequests();
};
window.cancelSentRequest = async (uid) => {
  await updateDoc(doc(db,"users",currentUser.uid), { sentRequests: arrayRemove(uid) });
  await updateDoc(doc(db,"users",uid), { friendRequests: arrayRemove(currentUser.uid) });
  currentUserDoc = (await getDoc(doc(db,"users",currentUser.uid))).data();
  renderSentRequests(); renderRequests();
};

/* subscribe posts on startup */
function subscribePosts(){
  if(postsUnsub) postsUnsub();
  const q = query(collection(db,"posts"), orderBy("time","desc"));
  postsUnsub = onSnapshot(q, snap => postListRender(snap.docs.map(d=>({ id:d.id, ...d.data() }))), err => console.warn(err));
}
</script>
</body>
</html>

