<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UniChat ‚Äî Friends & Posts</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
html,body{height:100%}
body{transition:background 0.3s,color 0.3s}
.dark body{background:#0f172a;color:#f1f5f9}
.dark .bg-white{background:#1e293b !important;color:#f8fafc}
.dark input,.dark textarea{background:#334155 !important;color:#f8fafc}
.flex-center{display:flex;align-items:center;gap:0.5rem}
audio{max-width:200px}
img.video-preview{max-width:200px;max-height:200px;border-radius:0.5rem}
.post-img{max-width:100%;border-radius:0.5rem}
</style>
</head>
<body class="bg-sky-50 text-slate-900 min-h-full">

<div class="max-w-6xl mx-auto p-4 grid gap-4">

<header class="flex items-center justify-between">
  <h1 class="text-2xl font-bold">UniChat <span class="text-sky-600">demo</span></h1>
  <nav class="flex items-center gap-2">
    <button class="menu-btn px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" data-tab="friendsTab">–î—Ä—É–∑—å—è</button>
    <button class="menu-btn px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" data-tab="feedTab">–õ–µ–Ω—Ç–∞</button>
    <button class="menu-btn px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300" data-tab="settingsTab">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </nav>
  <div class="flex items-center gap-3">
    <span id="userEmail" class="text-sm text-slate-600 cursor-pointer"></span>
    <label class="cursor-pointer">
      <input id="avatarUpload" type="file" accept="image/*" class="hidden"/>
      <img id="avatarImg" src="" alt="avatar" class="w-10 h-10 rounded-full border border-slate-300 object-cover cursor-pointer"/>
    </label>
    <button id="btnSignOut" class="hidden px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300">–í—ã–π—Ç–∏</button>
  </div>
</header>

<!-- Auth -->
<section id="auth" class="grid gap-3 bg-white rounded-2xl p-4 shadow">
  <h2 class="font-semibold">–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <div class="grid md:grid-cols-2 gap-3">
    <input id="email" type="email" placeholder="email" class="px-3 py-2 rounded-xl bg-slate-100"/>
    <input id="password" type="password" placeholder="–ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6)" class="px-3 py-2 rounded-xl bg-slate-100"/>
  </div>
  <div class="flex gap-2">
    <button id="btnRegister" class="px-4 py-2 rounded-xl bg-sky-600 text-white">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button id="btnLogin" class="px-4 py-2 rounded-xl bg-sky-600/70 text-white">–í–æ–π—Ç–∏</button>
    <label class="flex items-center gap-2 text-sm ml-2"><input id="remember" type="checkbox" checked/> –∑–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
  </div>
</section>

<!-- App -->
<section id="app" class="hidden grid gap-4">

<main class="grid md:grid-cols-[250px_1fr] gap-4">

  <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é: –¥—Ä—É–∑—å—è –∏ –ø–æ–∏—Å–∫ -->
  <aside class="bg-white rounded-2xl p-4 shadow grid gap-4 h-fit md:sticky top-4">

    <!-- –ü–æ–∏—Å–∫ –¥—Ä—É–∑–µ–π -->
    <div id="friendsTab" class="tab-content grid gap-2">
      <h3 class="font-semibold">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h3>
      <input id="friendSearch" placeholder="–ø–æ –Ω–∏–∫—É" class="px-3 py-2 rounded-xl bg-slate-100"/>
      <div id="friendResults" class="max-h-48 overflow-y-auto grid gap-1"></div>

      <div class="grid gap-2">
        <h3 class="font-semibold">–ú–æ–∏ –¥—Ä—É–∑—å—è</h3>
        <div id="friendList" class="max-h-[300px] overflow-y-auto grid gap-1"></div>
      </div>

      <div class="grid gap-2">
        <h3 class="font-semibold">–ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è</h3>
        <div id="friendRequests" class="max-h-[200px] overflow-y-auto grid gap-1"></div>
      </div>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div id="settingsTab" class="tab-content hidden grid gap-2">
      <h3 class="font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <button id="btnTheme2" class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">üåô –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
    </div>

  </aside>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ -->
  <section class="grid gap-4">

    <!-- –ß–∞—Ç -->
    <div id="chatEl" class="bg-white rounded-2xl p-4 shadow flex flex-col h-[400px] hidden">
      <h3 id="chatTitle" class="font-semibold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞</h3>
      <div id="messages" class="flex-1 overflow-y-auto grid gap-2 pr-2"></div>
      <div class="mt-3 flex gap-2">
        <input id="msgInput" placeholder="—Å–æ–æ–±—â–µ–Ω–∏–µ" class="px-3 py-2 rounded-xl bg-slate-100 flex-1"/>
        <input id="fileInput" type="file" accept="image/*,audio/*" class="hidden"/>
        <button id="btnFile" class="px-3 py-2 rounded-xl bg-slate-200">üìé</button>
        <button id="btnSend" class="px-4 py-2 rounded-xl bg-sky-600 text-white">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- –õ–µ–Ω—Ç–∞ -->
    <div id="feedTab" class="tab-content hidden">
      <h3 class="font-semibold mb-2">–õ–µ–Ω—Ç–∞</h3>
      <textarea id="postInput" placeholder="–í–∞—à –ø–æ—Å—Ç..." class="w-full px-3 py-2 rounded-xl bg-slate-100"></textarea>
      <input id="postFile" type="file" accept="image/*" class="hidden"/>
      <button id="btnPostFile" class="px-3 py-2 rounded-xl bg-slate-200 mt-2">üìé</button>
      <button id="btnPost" class="px-4 py-2 rounded-xl bg-sky-600 text-white mt-2">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      <div id="postList" class="mt-4 grid gap-2"></div>
    </div>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å –¥—Ä—É–≥–∞ -->
    <div id="friendProfile" class="hidden bg-white p-4 rounded-2xl shadow grid gap-2">
      <img id="friendAvatar" src="" class="w-20 h-20 rounded-full mx-auto"/>
      <h3 id="friendNick" class="text-xl font-semibold text-center"></h3>
      <p id="friendDesc" class="text-sm text-slate-600 text-center"></p>
      <div class="flex justify-center gap-2">
        <button id="btnAddFriend" class="px-3 py-2 rounded-xl bg-sky-600 text-white">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
        <button id="btnChatFriend" class="px-3 py-2 rounded-xl bg-green-600 text-white">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
      </div>
    </div>

    <!-- –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å -->
    <div id="myProfile" class="hidden bg-white p-4 rounded-2xl shadow grid gap-2">
      <label class="cursor-pointer mx-auto">
        <input id="myAvatarUpload" type="file" accept="image/*" class="hidden"/>
        <img id="myAvatarImg" src="" class="w-20 h-20 rounded-full mx-auto border border-slate-300 object-cover"/>
      </label>
      <input id="myNickInput" placeholder="–ù–∏–∫" class="px-3 py-2 rounded-xl bg-slate-100"/>
      <textarea id="myDescInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è" class="px-3 py-2 rounded-xl bg-slate-100"></textarea>
      <button id="btnSaveMyProfile" class="px-3 py-2 rounded-xl bg-sky-600 text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    </div>

  </section>

</main>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, inMemoryPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, setDoc, getDoc, updateDoc, query, orderBy, onSnapshot, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJeZ2RyApZueVvqYzdctLRTuo9kIfySzE",
  authDomain: "umi-chat-500c6.firebaseapp.com",
  projectId: "umi-chat-500c6",
  storageBucket: "umi-chat-500c6.appspot.com",
  messagingSenderId: "340727638941",
  appId: "1:340727638941:web:581218a8ff4fa098a85d74",
  measurementId: "G-DPPKQEF6BE"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// –≠–ª–µ–º–µ–Ω—Ç—ã
const authBox=document.getElementById("auth");
const appBox=document.getElementById("app");
const userEmail=document.getElementById("userEmail");
const avatarImg=document.getElementById("avatarImg");
const btnSignOut=document.getElementById("btnSignOut");
const messagesEl=document.getElementById("messages");
const msgInput=document.getElementById("msgInput");
const fileInput=document.getElementById("fileInput");
const btnFile=document.getElementById("btnFile");
const friendSearch=document.getElementById("friendSearch");
const friendResults=document.getElementById("friendResults");
const friendList=document.getElementById("friendList");
const friendRequests=document.getElementById("friendRequests");
const chatTitle=document.getElementById("chatTitle");
const chatEl=document.getElementById("chatEl");
const postInput=document.getElementById("postInput");
const btnPost=document.getElementById("btnPost");
const btnPostFile=document.getElementById("btnPostFile");
const postFile=document.getElementById("postFile");
const postList=document.getElementById("postList");
const friendProfile=document.getElementById("friendProfile");
const friendAvatar=document.getElementById("friendAvatar");
const friendNick=document.getElementById("friendNick");
const friendDesc=document.getElementById("friendDesc");
const btnAddFriend=document.getElementById("btnAddFriend");
const btnChatFriend=document.getElementById("btnChatFriend");
const myProfile=document.getElementById("myProfile");
const myAvatarUpload=document.getElementById("myAvatarUpload");
const myAvatarImg=document.getElementById("myAvatarImg");
const myNickInput=document.getElementById("myNickInput");
const myDescInput=document.getElementById("myDescInput");
const btnSaveMyProfile=document.getElementById("btnSaveMyProfile");
const menuBtns=document.querySelectorAll(".menu-btn");
const tabs=document.querySelectorAll(".tab-content");
const btnTheme=document.getElementById("btnTheme");
const btnTheme2=document.getElementById("btnTheme2");

let currentUser=null;
let currentChatId=null;
let selectedFriendUid=null;

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
document.getElementById("btnRegister").onclick=()=>createUserWithEmailAndPassword(auth,email.value,password.value).catch(alert);
document.getElementById("btnLogin").onclick=()=>{
  const persistence=remember.checked?browserLocalPersistence:inMemoryPersistence;
  setPersistence(auth,persistence).then(()=>signInWithEmailAndPassword(auth,email.value,password.value)).catch(alert);
};
btnSignOut.onclick=()=>signOut(auth);

onAuthStateChanged(auth,user=>{
  currentUser=user;
  if(user){
    authBox.classList.add("hidden");
    appBox.classList.remove("hidden");
    userEmail.textContent=user.email;
    avatarImg.src=user.photoURL||"";
    loadFriends();
    loadRequests();
    loadPosts();
  }else{
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
  }
});

// –ú–µ–Ω—é –≤–∫–ª–∞–¥–æ–∫
menuBtns.forEach(btn=>{
  btn.onclick=()=>{
    const target=btn.dataset.tab;
    tabs.forEach(tab=>tab.classList.add("hidden"));
    document.getElementById(target).classList.remove("hidden");
    friendProfile.classList.add("hidden");
    myProfile.classList.add("hidden");
    chatEl.classList.add("hidden");
  };
});

// –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
avatarImg.onclick=myProfileOpen;
userEmail.onclick=myProfileOpen;
function myProfileOpen(){
  myProfile.classList.remove("hidden");
  friendProfile.classList.add("hidden");
  chatEl.classList.add("hidden");
  tabs.forEach(tab=>tab.classList.add("hidden"));
  myAvatarImg.src=currentUser.photoURL||"";
  myNickInput.value=currentUser.displayName||"";
  myDescInput.value=currentUser.description||"";
}
myAvatarUpload.onchange=async e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=async ()=>{
    const base64=reader.result;
    myAvatarImg.src=base64;
    await updateProfile(currentUser,{photoURL:base64});
    await setDoc(doc(db,"users",currentUser.uid),{photoURL:base64},{merge:true});
  };
  reader.readAsDataURL(file);
};
btnSaveMyProfile.onclick=async()=>{
  await updateProfile(currentUser,{displayName:myNickInput.value});
  await setDoc(doc(db,"users",currentUser.uid),{
    displayName:myNickInput.value,
    description:myDescInput.value
  },{merge:true});
  alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
};

// –¢–µ–º–∞
btnTheme.onclick=()=>document.documentElement.classList.toggle("dark");
btnTheme2.onclick=btnTheme.onclick;

// –î—Ä—É–∑—å—è
async function searchFriends(){
  friendResults.innerHTML="";
  const q=friendSearch.value.trim().toLowerCase();
  if(!q) return;
  const usersSnap=await getDocs(collection(db,"users"));
  usersSnap.forEach(u=>{
    const d=u.data();
    if(d.displayName.toLowerCase().includes(q) && u.id!==currentUser.uid){
      const div=document.createElement("div");
      div.className="flex items-center gap-2 cursor-pointer";
      div.innerHTML=`<img src="${d.photoURL||''}" class="w-8 h-8 rounded-full"/> <span>${d.displayName}</span>`;
      div.onclick=()=>openFriendProfile(u.id,d);
      friendResults.appendChild(div);
    }
  });
}
friendSearch.oninput=searchFriends;

async function openFriendProfile(uid,data){
  selectedFriendUid=uid;
  friendAvatar.src=data.photoURL||"";
  friendNick.textContent=data.displayName;
  friendDesc.textContent=data.description||"–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è";
  friendProfile.classList.remove("hidden");
  chatEl.classList.add("hidden");
  myProfile.classList.add("hidden");
}

btnAddFriend.onclick=async()=>{
  if(!selectedFriendUid) return;
  await sendRequest(selectedFriendUid);
};

btnChatFriend.onclick=()=>{
  if(!selectedFriendUid) return;
  openChat(selectedFriendUid,friendNick.textContent);
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏
async function sendRequest(uid){
  const userRef=doc(db,"users",uid);
  await updateDoc(userRef,{requests:arrayUnion(currentUser.uid)});
  alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
  loadRequests();
}

// –ó–∞—è–≤–∫–∏
async function loadRequests(){
  friendRequests.innerHTML="";
  const docSnap=await getDoc(doc(db,"users",currentUser.uid));
  const data=docSnap.data();
  (data.requests||[]).forEach(async reqUid=>{
    const reqSnap=await getDoc(doc(db,"users",reqUid));
    const reqData=reqSnap.data();
    const div=document.createElement("div");
    div.className="flex justify-between items-center";
    div.innerHTML=`<span>${reqData.displayName}</span>
    <div class="flex gap-1">
      <button class="px-2 py-1 bg-green-600 text-white rounded" onclick="acceptRequest('${reqUid}')">–ü—Ä–∏–Ω—è—Ç—å</button>
      <button class="px-2 py-1 bg-red-600 text-white rounded" onclick="declineRequest('${reqUid}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>`;
    friendRequests.appendChild(div);
  });
}
window.acceptRequest=async(uid)=>{
  await updateDoc(doc(db,"users",currentUser.uid),{friends:arrayUnion(uid),requests:arrayRemove(uid)});
  await updateDoc(doc(db,"users",uid),{friends:arrayUnion(currentUser.uid)});
  loadFriends(); loadRequests();
};
window.declineRequest=async(uid)=>{
  await updateDoc(doc(db,"users",currentUser.uid),{requests:arrayRemove(uid)});
  loadRequests();
};

// –î—Ä—É–∑—å—è —Å–ø–∏—Å–æ–∫
async function loadFriends(){
  friendList.innerHTML="";
  const userSnap=await getDoc(doc(db,"users",currentUser.uid));
  const data=userSnap.data();
  (data.friends||[]).forEach(async fuid=>{
    const fSnap=await getDoc(doc(db,"users",fuid));
    const fdata=fSnap.data();
    if(!fdata) return;
    const div=document.createElement("div");
    div.className="flex items-center gap-2 cursor-pointer justify-between";
    div.innerHTML=`<div class="flex items-center gap-2">
      <img src="${fdata.photoURL||''}" class="w-6 h-6 rounded-full"/>
      <span>${fdata.displayName}</span>
    </div>
    <button class="px-2 py-1 bg-red-600 text-white rounded" onclick="removeFriend('${fuid}')">–£–¥–∞–ª–∏—Ç—å</button>`;
    div.onclick=()=>openChat(fuid,fdata.displayName);
    friendList.appendChild(div);
  });
}
window.removeFriend=async(uid)=>{
  await updateDoc(doc(db,"users",currentUser.uid),{friends:arrayRemove(uid)});
  await updateDoc(doc(db,"users",uid),{friends:arrayRemove(currentUser.uid)});
  loadFriends();
};

// –ß–∞—Ç
async function openChat(friendUid,friendName){
  chatEl.classList.remove("hidden");
  currentChatId=[currentUser.uid,friendUid].sort().join("_");
  chatTitle.textContent="–ß–∞—Ç —Å "+friendName;
  messagesEl.innerHTML="";
  const messagesRef=query(collection(db,"chats",currentChatId,"messages"),orderBy("time"));
  onSnapshot(messagesRef,snap=>{
    messagesEl.innerHTML="";
    snap.forEach(doc=>renderMessage(doc.id,doc.data()));
    messagesEl.scrollTop=messagesEl.scrollHeight;
  });
}
document.getElementById("btnSend").onclick=async()=>{
  if(!currentChatId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞!");
  let content=msgInput.value.trim();
  if(!content) return;
  await addDoc(collection(db,"chats",currentChatId,"messages"),{
    uid:currentUser.uid,
    avatar:currentUser.photoURL,
    type:"text",
    content,
    time:Date.now()
  });
  msgInput.value="";
};
btnFile.onclick=()=>fileInput.click();
fileInput.onchange=async e=>{
  if(!currentChatId) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∞!");
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=async ()=>{
    const content=reader.result;
    const type=file.type.startsWith("image")?"image":"voice";
    await addDoc(collection(db,"chats",currentChatId,"messages"),{
      uid:currentUser.uid,
      avatar:currentUser.photoURL,
      type,
      content,
      time:Date.now()
    });
  };
  reader.readAsDataURL(file);
};
function renderMessage(id,m){
  const wrap=document.createElement("div");
  wrap.className="flex gap-2 items-start msg p-2 rounded-xl bg-slate-50 border dark:bg-slate-800 dark:text-slate-100";
  let inner="";
  if(m.type==="text") inner=`<div>${m.content}</div>`;
  else if(m.type==="voice") inner=`<audio controls src="${m.content}"></audio>`;
  else if(m.type==="image") inner=`<img class="video-preview" src="${m.content}"/>`;
  wrap.innerHTML=`<img src="${m.avatar||''}" class="w-8 h-8 rounded-full"/><div class="flex flex-col"><div class="text-xs text-slate-500 dark:text-slate-400">${m.uid===currentUser.uid?"–í—ã":""}</div>${inner}</div>`;
  messagesEl.appendChild(wrap);
}

// –ü–æ—Å—Ç—ã
btnPost.onclick=async()=>{
  let content=postInput.value.trim();
  if(!content && !postFile.files[0]) return;
  let fileData="";
  if(postFile.files[0]){
    const reader=new FileReader();
    reader.onload=async ()=>{
      fileData=reader.result;
      await addPost(content,fileData);
    };
    reader.readAsDataURL(postFile.files[0]);
  }else{
    await addPost(content,"");
  }
  postInput.value=""; postFile.value="";
};
btnPostFile.onclick=()=>postFile.click();
async function addPost(content,file){
  await addDoc(collection(db,"posts"),{
    uid:currentUser.uid,
    avatar:currentUser.photoURL,
    content,
    file,
    time:Date.now()
  });
  loadPosts();
}
async function loadPosts(){
  postList.innerHTML="";
  const postsSnap=await getDocs(collection(db,"posts"));
  postsSnap.forEach(async docSnap=>{
    const data=docSnap.data();
    const div=document.createElement("div");
    div.className="border p-2 rounded-xl";
    if(data.file) div.innerHTML=`<div>${data.content}</div><img src="${data.file}" class="post-img"/>`;
    else div.innerHTML=`<div>${data.content}</div>`;
    postList.appendChild(div);
  });
}

</script>
</body>
</html>
